-- ====================== AUTO AIM ASSIST KE HEAD (SAAT SHIFT LOCK) ======================

local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

local AIM_ASSIST_RANGE = 12       -- max jarak angular (derajat) untuk dianggap "dekat"
local AIM_ASSIST_STRENGTH = 0.45  -- 0 = mati, 1 = langsung snap, 0.4~0.6 biasanya smooth & wajar

local function isShiftLockActive()
    -- Cara paling reliable di 2025-2026
    return UserInputService.MouseBehavior == Enum.MouseBehavior.LockCenter
end

local function getClosestHeadToCrosshair()
    if not enabled then return nil end
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return nil end
    
    local rootPart = player.Character.HumanoidRootPart
    local viewportSize = Camera.ViewportSize
    local centerScreen = Vector2.new(viewportSize.X/2, viewportSize.Y/2)
    
    local bestHead = nil
    local bestAngle = AIM_ASSIST_RANGE
    
    for playerOther, highlight in pairs(highlights) do
        if not highlight.Adornee then continue end
        
        local head = highlight.Adornee
        if not head:IsA("BasePart") then continue end
        
        local screenPos, onScreen = Camera:WorldToViewportPoint(head.Position)
        
        if onScreen then
            local distanceToCenter = (Vector2.new(screenPos.X, screenPos.Y) - centerScreen).Magnitude
            
            -- Konversi ke angle (lebih akurat daripada pixel)
            local direction = (head.Position - Camera.CFrame.Position).Unit
            local forward = Camera.CFrame.LookVector
            
            local angle = math.deg(math.acos(forward:Dot(direction)))
            
            if angle < bestAngle then
                bestAngle = angle
                bestHead = head
            end
        end
    end
    
    return bestHead
end

-- ==========================================
--      SISTEM AIM ASSIST (SMOOTH)
-- ==========================================

local currentTargetHead = nil

RunService.RenderStepped:Connect(function(deltaTime)
    if not isShiftLockActive() then 
        currentTargetHead = nil
        return 
    end
    
    local closestHead = getClosestHeadToCrosshair()
    
    if closestHead and closestHead.Parent then
        currentTargetHead = closestHead
    else
        currentTargetHead = nil
        return
    end
    
    local rootPart = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    local targetPos = currentTargetHead.Position
    
    -- Arah yang diinginkan
    local desiredCFrame = CFrame.new(rootPart.Position, targetPos)
    
    -- Smooth lerp
    local currentCFrame = rootPart.CFrame
    local newCFrame = currentCFrame:Lerp(desiredCFrame, AIM_ASSIST_STRENGTH)
    
    -- Jaga agar tetap horizontal (tidak ikut naik/turun terlalu ekstrim)
    local lookVector = (targetPos - rootPart.Position).Unit
    local flatLook = Vector3.new(lookVector.X, 0, lookVector.Z).Unit
    
    if flatLook.Magnitude > 0.01 then
        rootPart.CFrame = CFrame.new(rootPart.Position) * CFrame.new(Vector3.new(), flatLook)
    end
end)

print("Auto aim assist to head (shift lock) telah aktif!")
